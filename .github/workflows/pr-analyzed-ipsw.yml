name: 2. Commit and PR Analysis

on:
  workflow_dispatch:
    inputs:
      analysis_type:
        description: 'Type of analysis (beta or release)'
        required: true
        type: choice
        options:
          - beta
          - release
      os_type:
        description: 'Operating System (iOS, iPadOS, macOS, visionOS)'
        required: true
        type: choice
        options:
          - iOS
          - iPadOS
          - macOS
          - visionOS
      device_identifier:
        description: 'Device Identifier (e.g., iPhone18,1)'
        required: true
        type: string
      beta_version:
        description: '[IF BETA] Version (e.g., 26.0).'
        required: false
        type: string
      beta_build:
        description: '[IF BETA] Build ID (e.g., 23B5073a).'
        required: false
        type: string
      release_version:
        description: '[IF RELEASE] Version (e.g., 17.5.1).'
        required: false
        type: string
      run_id:
        description: 'The specific Run ID of the "Analyzer" workflow to pull from.'
        required: true
        type: string
      pr_base_branch:
        description: 'The base branch to create the Pull Request against.'
        required: false
        type: string
        default: 'main'

jobs:
  create-pr:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
      actions: read
    
    steps:
      - name: 1. Validate inputs
        run: |
          if [[ "${{ inputs.analysis_type }}" == "beta" && ("${{ inputs.beta_version }}" == "" || "${{ inputs.beta_build }}" == "") ]]; then
            echo "::error::For 'beta' analysis, 'beta_version' and 'beta_build' are required."
            exit 1
          fi
          if [[ "${{ inputs.analysis_type }}" == "release" && "${{ inputs.release_version }}" == "" ]]; then
            echo "::error::For 'release' analysis, 'release_version' is required."
            exit 1
          fi
          echo "Inputs validated."

      - name: 2. Set environment variables based on type
        run: |
          if [[ "${{ inputs.analysis_type }}" == "beta" ]]; then
            echo "Setting variables for BETA"
            echo "DIR_PATH=beta" >> $GITHUB_ENV
            echo "ARTIFACT_NAME=analysis-beta-${{ inputs.os_type }}-${{ inputs.beta_build }}-${{ inputs.device_identifier }}" >> $GITHUB_ENV
            echo "VERSION_STRING=${{ inputs.beta_version }} (${{ inputs.beta_build }})" >> $GITHUB_ENV
            echo "TAG_VERSION=${{ inputs.beta_version }}-${{ inputs.beta_build }}" >> $GITHUB_ENV
            echo "PR_PREFIX=Analysis" >> $GITHUB_ENV
            echo "BRANCH_PREFIX=auto-analysis" >> $GITHUB_ENV
          else
            echo "Setting variables for RELEASE"
            echo "DIR_PATH=release" >> $GITHUB_ENV
            echo "ARTIFACT_NAME=analysis-release-${{ inputs.os_type }}-${{ inputs.release_version }}-${{ inputs.device_identifier }}" >> $GITHUB_ENV
            echo "VERSION_STRING=${{ inputs.release_version }}" >> $GITHUB_ENV
            echo "TAG_VERSION=${{ inputs.release_version }}" >> $GITHUB_ENV
            echo "PR_PREFIX=Analysis [Release]" >> $GITHUB_ENV
            echo "BRANCH_PREFIX=auto-analysis-release" >> $GITHUB_ENV
          fi

      - name: 3. Log Inputs to Job Summary
        run: |
          echo "### ðŸ“¦ Workflow: 2. Commit Analysis" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Input | Value |" >> $GITHUB_STEP_SUMMARY
          echo "| :--- | :--- |" >> $GITHUB_STEP_SUMMARY
          echo "| **Analysis Type** | \`${{ inputs.analysis_type }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **OS Type** | \`${{ inputs.os_type }}\` |" >> $GITHUB_STEP_SUMMARY
          if [[ "${{ inputs.analysis_type }}" == "beta" ]]; then
            echo "| **Beta Version** | \`${{ inputs.beta_version }}\` |" >> $GITHUB_STEP_SUMMARY
            echo "| **Beta Build** | \`${{ inputs.beta_build }}\` |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| **Release Version** | \`${{ inputs.release_version }}\` |" >> $GITHUB_STEP_SUMMARY
          fi
          echo "| **Device** | \`${{ inputs.device_identifier }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **Source Run ID** | \`${{ inputs.run_id }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **PR Base Branch** | \`${{ inputs.pr_base_branch }}\` |" >> $GITHUB_STEP_SUMMARY

      - name: 4. Check out repository
        uses: actions/checkout@v4
        with:
          ref: ${{ inputs.pr_base_branch }}

      - name: 5. Clean old directory
        run: |
          echo "Removing old directory: ${{ env.DIR_PATH }}/${{ inputs.os_type }}"
          rm -rf ${{ env.DIR_PATH }}/${{ inputs.os_type }}

      - name: 6. Download and Verify Artifact
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -e 
          
          ARTIFACT_NAME="${{ env.ARTIFACT_NAME }}"
          TARGET_DIR="${{ env.DIR_PATH }}/${{ inputs.os_type }}"
          
          echo "Attempting to download artifact: ${ARTIFACT_NAME}"
          echo "From Run ID: ${{ inputs.run_id }}"
          
          mkdir -p "${TARGET_DIR}"
          
          gh run download ${{ inputs.run_id }} \
            --name "${ARTIFACT_NAME}" \
            --dir "${TARGET_DIR}"
          
          echo "Download command finished."
          
          echo "Verifying that '${TARGET_DIR}' is not empty..."
          if [ -z "$(ls -A "${TARGET_DIR}")" ]; then
            echo "::error::Verification failed! The directory '${TARGET_DIR}' is empty."
            echo "This means the artifact download failed, likely due to a wrong artifact name, run_id, or input mismatch."
            echo "Artifact sought: ${ARTIFACT_NAME}"
            exit 1
          fi
          
          echo "Verification successful. Artifact files are present."

      - name: 7. Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

      - name: 8. Commit and Create PR
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail
          
          OS_TYPE_LOWER=$(echo "${{ inputs.os_type }}" | tr '[:upper:]' '[:lower:]')
          CLEAN_VERSION_TAG=$(echo "${OS_TYPE_LOWER}-${{ env.TAG_VERSION }}" | sed 's/[^a-zA-Z0-9-]/_/g')
          TIMESTAMP=$(date +'%Y%m%d-%H%M%S')
          NEW_BRANCH="${{ env.BRANCH_PREFIX }}/${CLEAN_VERSION_TAG}-${TIMESTAMP}"
          
          git checkout -B "${NEW_BRANCH}"
          git add ${{ env.DIR_PATH }}/
          
          if git diff --cached --quiet; then
            echo "No changes detected in '${{ env.DIR_PATH }}' directory. Exiting."
            exit 0
          fi
          
          echo "Committing changes..."
          COMMIT_MSG="${{ env.PR_PREFIX }}: ${{ inputs.os_type }} ${{ env.VERSION_STRING }}
          
          Device: ${{ inputs.device_identifier }}
          Processed folders: Applications, Library, private, System"
          
          git commit -m "$COMMIT_MSG"
          
          echo "Pushing branch ${NEW_BRANCH}..."
          git push --set-upstream origin "${NEW_BRANCH}"
          
          echo "Creating Pull Request..."
          PR_TITLE="${{ env.PR_PREFIX }}: ${{ inputs.os_type }} ${{ env.VERSION_STRING }}"
          PR_BODY="Automated analysis of \`${{ inputs.analysis_type }}\` \`${{ inputs.os_type }}\` \`${{ env.VERSION_STRING }}\`.
          
          **Device:** \`${{ inputs.device_identifier }}\`
          **Processed DMG Folders:** \`Applications\`, \`Library\`, \`private\`, \`System\`
          **Output Repo Path:** \`/${{ env.DIR_PATH }}/${{ inputs.os_type }}\`"
          
          gh pr create \
            --base "${{ inputs.pr_base_branch }}" \
            --head "${NEW_BRANCH}" \
            --title "${PR_TITLE}" \
            --body "${PR_BODY}"