name: Process iOS Beta IPSW

on:
  workflow_dispatch:
    inputs:
      beta_version:
        description: 'iOS Version (e.g., 18.1). Used for the version tag in the PR title and branch name.'
        required: true
      beta_build:
        description: 'Build ID (e.g., 22B5044l). Used for downloading the IPSW file.'
        required: true
      device_identifier:
        description: 'Device Identifier (e.g., iPhone18,1)'
        required: true

jobs:
  process-ipsw:
    runs-on: macos-latest # Required for hdiutil, plutil, and ipsw
    permissions:
      contents: write     # To push branches and commit
      pull-requests: write # To create the pull request
    
    steps:
      - name: 1. Check out repository
        uses: actions/checkout@v4

      - name: 2. Install blacktop/ipsw
        run: brew install blacktop/tap/ipsw

      - name: 3. Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: 4. Download IPSW
        run: |
          echo "Downloading full IPSW for iOS ${{ inputs.beta_version }} (${{ inputs.beta_build }}) for device ${{ inputs.device_identifier }}"
          ipsw dl appledb --os iOS --build "${{ inputs.beta_build }}" --device "${{ inputs.device_identifier }}" --output ./ipsw_files
          
          DOWNLOADED_FILE=$(find ./ipsw_files -name "*.ipsw" | head -n 1)
          if [[ -z "$DOWNLOADED_FILE" ]]; then
            echo "::error::Failed to download IPSW file."
            exit 1
          fi
          echo "IPSW_FILE=${DOWNLOADED_FILE}" >> $GITHUB_ENV
          echo "Downloaded: $DOWNLOADED_FILE"

      - name: 5. Extract Filesystem DMG and Decrypt
        run: |
          echo "Processing file: ${{ env.IPSW_FILE }}"
          
          echo "Extracting filesystem DMG..."
          ipsw extract "${{ env.IPSW_FILE }}" --dmg filesystem --output ./ipsw_files
          FS_DMG_AEA=$(find ./ipsw_files -name "*dmg.aea" | head -n 1)
          if [[ -z "$FS_DMG_AEA" ]]; then
            echo "::error::Failed to find extracted *dmg.aea file."
            exit 1
          fi
          echo "FS_DMG_AEA=${FS_DMG_AEA}" >> $GITHUB_ENV
          echo "Found encrypted DMG: $FS_DMG_AEA"

          echo "Extracting decryption key..."
          ipsw ota aea key "${{ env.IPSW_FILE }}" --output ./ipsw_files
          AEA_KEY=$(find ./ipsw_files -name "*aea.pem" | head -n 1)
          if [[ -z "$AEA_KEY" ]]; then
            echo "::error::Failed to find extracted *aea.pem key."
            exit 1
          fi
          echo "AEA_KEY=${AEA_KEY}" >> $GITHUB_ENV
          echo "Found key: $AEA_KEY"

          echo "Decrypting DMG..."
          ipsw ota aea decrypt --key "${{ env.AEA_KEY }}" "${{ env.FS_DMG_AEA }}" ./ipsw_files/filesystem.dmg
          echo "DECRYPTED_DMG=./ipsw_files/filesystem.dmg" >> $GITHUB_ENV
          echo "Decrypted DMG at: ${{ env.DECRYPTED_DMG }}"

      - name: 6. Mount Decrypted DMG
        run: |
          echo "Mounting DMG..."
          hdiutil attach "${{ env.DECRYPTED_DMG }}" -mountpoint ./mounted_dmg
          echo "MOUNT_PATH=./mounted_dmg" >> $GITHUB_ENV
          echo "DMG mounted at: ${{ env.MOUNT_PATH }}"
          ls -l ${{ env.MOUNT_PATH }}

      - name: 7. Clean old beta directory
        run: |
          echo "Removing old 'beta' directory..."
          rm -rf beta
          mkdir -p beta

      - name: 8. Run Python Analyzer Script
        run: |
          # This is the hardcoded path in your repo where files will be saved
          REPO_SAVE_PATH="beta"

          echo "Running Python script for Applications..."
          python py.py "${{ env.MOUNT_PATH }}/Applications" "$REPO_SAVE_PATH"
          
          echo "Running Python script for Library..."
          python py.py "${{ env.MOUNT_PATH }}/Library" "$REPO_SAVE_PATH"
          
          echo "Running Python script for private..."
          python py.py "${{ env.MOUNT_PATH }}/private" "$REPO_SAVE_PATH"
          
          echo "Running Python script for System..."
          python py.py "${{ env.MOUNT_PATH }}/System" "$REPO_SAVE_PATH"

      - name: 9. Unmount DMG
        if: always() # Always run this step, even if the script fails
        run: |
          echo "Unmounting DMG..."
          hdiutil detach ./mounted_dmg -force

      - name: 10. Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

      - name: 11. Commit and Create PR
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail
          
          VERSION_TAG="ios-${{ inputs.beta_version }}-${{ inputs.beta_build }}"
          # Create a git-safe timestamp (YYYYMMDD-HHMMSS)
          TIMESTAMP=$(date +'%Y%m%d-%H%M%S')
          # Append timestamp to branch name for uniqueness
          NEW_BRANCH="auto-analysis/${VERSION_TAG}-${TIMESTAMP}"
          
          # Create new branch
          git checkout -B "${NEW_BRANCH}"
          
          # Add all new/modified files from the python script
          git add beta/
          
          if git diff --cached --quiet; then
            echo "No changes detected in 'beta' directory. Exiting."
            exit 0
          fi
          
          echo "Committing changes..."
          COMMIT_MSG="Analyze: iOS ${{ inputs.beta_version }} (${{ inputs.beta_build }})
          
          Device: ${{ inputs.device_identifier }}
          Processed folders: Applications, Library, private, System"
          
          git commit -m "$COMMIT_MSG"
          
          echo "Pushing branch ${NEW_BRANCH}..."
          git push --set-upstream origin "${NEW_BRANCH}"
          
          echo "Creating Pull Request..."
          PR_TITLE="Analysis: iOS ${{ inputs.beta_version }} (${{ inputs.beta_build }})"
          PR_BODY="Automated analysis of iOS \`${{ inputs.beta_version }}\` (Build \`${{ inputs.beta_build }}\`).
          
          **Device:** \`${{ inputs.device_identifier }}\`
          **Processed DMG Folders:** \`Applications\`, \`Library\`, \`private\`, \`System\`
          **Output Repo Path:** \`/beta\`"
          
          gh pr create \
            --base "main" \
            --head "${NEW_BRANCH}" \
            --title "${PR_TITLE}" \
            --body "${PR_BODY}"