name: 1. Process Apple Beta IPSW

on:
  workflow_dispatch:
    inputs:
      os_type:
        description: 'Operating System (e.g., iOS, iPadOS, visionOS)'
        required: true
        type: choice
        options:
          - iOS
          - iPadOS
          - visionOS
          - tvOS
          - macOS
      beta_version:
        description: 'Version (e.g., 26.0). Used for the version tag.'
        required: true
        type: string
      beta_build:
        description: 'Build ID (e.g., 23B5073a). Used for downloading.'
        required: true
        type: string
      device_identifier:
        description: 'Device Identifier (e.g., iPhone18,1)'
        required: true
        type: string
      checkout_branch:
        description: 'The base branch (for checkout, not PR since PR is handled by the other workflow).'
        required: false
        type: string
        default: 'main'

jobs:
  process-ipsw:
    runs-on: macos-latest
    
    steps:
      - name: 1. Log Inputs to Job Summary
        run: |
          echo "### ðŸš€ Workflow: 1. Process Apple Beta IPSW" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Input | Value |" >> $GITHUB_STEP_SUMMARY
          echo "| :--- | :--- |" >> $GITHUB_STEP_SUMMARY
          echo "| **OS Type** | \`${{ inputs.os_type }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **Beta Version** | \`${{ inputs.beta_version }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **Beta Build** | \`${{ inputs.beta_build }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **Device** | \`${{ inputs.device_identifier }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **Checkout Branch** | \`${{ inputs.checkout_branch }}\` |" >> $GITHUB_STEP_SUMMARY

      - name: 2. Check out repository
        uses: actions/checkout@v4
        with:
          ref: ${{ inputs.checkout_branch }}

      - name: 3. Install blacktop/ipsw
        run: brew install blacktop/tap/ipsw

      - name: 4. Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: 5. Create output directories
        run: |
          mkdir -p ./ipsw_files
          mkdir -p ./ipsw_files/out

      - name: 6. Download IPSW
        run: |
          echo "Downloading full IPSW for ${{ inputs.os_type }} build ${{ inputs.beta_build }} for device ${{ inputs.device_identifier }}"
          
          ipsw dl appledb --os "${{ inputs.os_type }}" \
            --build "${{ inputs.beta_build }}" \
            --device "${{ inputs.device_identifier }}" \
            --output ./ipsw_files
          
          DOWNLOADED_FILE=$(find ./ipsw_files -name "*.ipsw" | head -n 1)
          if [[ -z "$DOWNLOADED_FILE" ]]; then
            echo "::error::Failed to download IPSW file."
            exit 1
          fi
          echo "IPSW_FILE=${DOWNLOADED_FILE}" >> $GITHUB_ENV
          echo "Downloaded: $DOWNLOADED_FILE"

      - name: 7. Extract and Decrypt Filesystem DMG
        run: |
          echo "Extracting filesystem DMG (encrypted)..."
          ipsw ex --dmg fs "${{ env.IPSW_FILE }}" -o ./ipsw_files/out
          
          FS_DMG_AEA=$(find ./ipsw_files/out -name "*dmg.aea" | head -n 1)
          if [[ -z "$FS_DMG_AEA" ]]; then
            echo "::error::Failed to find extracted *dmg.aea file."
            exit 1
          fi
          echo "Found encrypted DMG: $FS_DMG_AEA"

          echo "Extracting decryption key (.pem)..."
          ipsw ex --fcs-key "${{ env.IPSW_FILE }}" -o ./ipsw_files/out
          
          AEA_KEY=$(find ./ipsw_files/out -name "*aea.pem" | head -n 1)
          if [[ -z "$AEA_KEY" ]]; then
            echo "::error::Failed to find extracted *aea.pem key."
            exit 1
          fi
          echo "Found key: $AEA_KEY"

          echo "Decrypting DMG..."
          ipsw fw aea --pem "${AEA_KEY}" "${FS_DMG_AEA}" -o ./ipsw_files/out
          
          DECRYPTED_DMG=$(find ./ipsw_files/out -name "*.dmg" | head -n 1)
          if [[ -z "$DECRYPTED_DMG" ]]; then
            echo "::error::Failed to find decrypted .dmg file."
            exit 1
          fi
          echo "DECRYPTED_DMG=${DECRYPTED_DMG}" >> $GITHUB_ENV
          echo "Decrypted DMG at: $DECRYPTED_DMG"

      - name: 8. Mount Decrypted DMG
        run: |
          echo "Mounting DMG..."
          hdiutil attach "${{ env.DECRYPTED_DMG }}" -mountpoint ./mounted_dmg
          echo "MOUNT_PATH=./mounted_dmg" >> $GITHUB_ENV
          echo "DMG mounted at: ${{ env.MOUNT_PATH }}"
          ls -l ${{ env.MOUNT_PATH }}

      - name: 9. Clean old beta directory
        run: |
          echo "Ensuring the 'beta' root directory exists..."
          mkdir -p beta

      - name: 10. Run Python Analyzer Script and Log Stats
        run: |
          REPO_SAVE_PATH="beta/${{ inputs.os_type }}"
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“Š Python Processing Stats" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Folder | Duration | Files Found | Files Processed | Errors | Avg. Time (s) |" >> $GITHUB_STEP_SUMMARY
          echo "| :--- | :--- | :--- | :--- | :--- | :--- |" >> $GITHUB_STEP_SUMMARY

          # --- Define a helper function to run and log each folder ---
          run_and_log() {
            FOLDER_NAME=$1
            MOUNT_PATH=$2
            REPO_PATH=$3
            
            echo "--- Processing $FOLDER_NAME ---"
            
            START_TIME=$(date +%s)
            
            JSON_OUTPUT=$(python py.py "$MOUNT_PATH" "$REPO_PATH")
            
            END_TIME=$(date +%s)
            DURATION_S=$((END_TIME - START_TIME))
            DURATION_FORMATTED=$(printf "%02d:%02d" $((DURATION_S/60)) $((DURATION_S%60)))

            if ! echo "$JSON_OUTPUT" | jq empty; then
              echo "::error::Failed to process $FOLDER_NAME. Output was not valid JSON."
              echo "Raw output: $JSON_OUTPUT"
              echo "| **$FOLDER_NAME** | $DURATION_FORMATTED | *Failed* | *Failed* | *Failed* | *Failed* |" >> $GITHUB_STEP_SUMMARY
              return
            fi

            FILES_FOUND=$(echo "$JSON_OUTPUT" | jq .files_found)
            FILES_PROCESSED=$(echo "$JSON_OUTPUT" | jq .valid_files_processed)
            ERROR_COUNT=$(echo "$JSON_OUTPUT" | jq .error_count)
            AVG_TIME=$(echo "$JSON_OUTPUT" | jq .avg_time_s | xargs printf "%.3f")

            # This log line is good confirmation *after* the python script's logs
            echo "Finished $FOLDER_NAME processing (Duration: $DURATION_FORMATTED)"

            # Append to GitHub Job Summary
            echo "| **$FOLDER_NAME** | $DURATION_FORMATTED | $FILES_FOUND | $FILES_PROCESSED | $ERROR_COUNT | $AVG_TIME |" >> $GITHUB_STEP_SUMMARY
            
            if [[ "$ERROR_COUNT" -gt 0 ]]; then
              echo "::warning::Encountered $ERROR_COUNT errors processing $FOLDER_NAME. See logs above for details."
            fi
          }

          # --- Execute for each folder ---
          run_and_log "Applications" "${{ env.MOUNT_PATH }}/Applications" "${REPO_SAVE_PATH}/Applications"
          run_and_log "Library" "${{ env.MOUNT_PATH }}/Library" "${REPO_SAVE_PATH}/Library"
          run_and_log "private" "${{ env.MOUNT_PATH }}/private" "${REPO_SAVE_PATH}/private"
          run_and_log "System" "${{ env.MOUNT_PATH }}/System" "${REPO_SAVE_PATH}/System"

      - name: 11. Sanitize File Paths
        run: |
          echo "Searching for and renaming files/directories with colons..."
          find ./beta -depth -name "*:*" -exec bash -c '
            dir=$(dirname "$0")
            base=$(basename "$0")
            new_base=$(echo "$base" | tr ":" "_")
            if [[ "$base" != "$new_base" ]]; then
              echo "Renaming $0 to $dir/$new_base"
              mv "$0" "$dir/$new_base"
            fi
          ' {} \;
          echo "Sanitization complete."

      - name: 12. Unmount DMG
        if: always()
        run: |
          echo "Unmounting DMG..."
          hdiutil detach ./mounted_dmg -force

      - name: 13. Upload Analysis Artifact
        uses: actions/upload-artifact@v4
        with:
          name: analysis-${{ inputs.os_type }}-${{ inputs.beta_build }}-${{ inputs.device_identifier }}
          path: ./beta/${{ inputs.os_type }}
          retention-days: 5